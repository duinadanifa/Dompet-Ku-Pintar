<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manajemen Uang — Juring per Transaksi</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #eaf7ea;
    --card: #ffffff;
    --accent: #0b7a0b;
    --accent-2: #2ea44f;
    --danger: #d32f2f;
    --muted: #6b7280;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#062018;
    display:flex;
    justify-content:center;
    padding:22px;
  }

  .app{
    width:100%;
    max-width:880px;
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
  }
  h1{margin:0;font-size:20px;color:var(--accent)}
  .date{color:var(--muted); font-weight:600}

  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:0 10px 30px rgba(2,6,23,0.06);
  }

  .form-row{display:flex; gap:12px; margin-top:10px;}
  .col{flex:1}
  label{display:block;font-weight:600;color:var(--muted); font-size:13px; margin-bottom:6px}
  input[type="number"], input[type="text"], select{
    width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); font-size:14px;
  }

  .controls{display:flex; gap:10px; margin-top:12px}
  button.btn{
    background:var(--accent);
    color:white;
    padding:10px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:700;
  }
  button.ghost{
    background:transparent;
    color:var(--muted);
    border:1px solid rgba(0,0,0,0.06);
  }
  button.danger{ background:var(--danger); }

  table{width:100%; border-collapse:collapse; margin-top:16px; font-size:14px}
  th{background:var(--accent-2); color:white; text-align:left; padding:10px; border-bottom:2px solid rgba(0,0,0,0.04)}
  td{padding:10px; border-bottom:1px solid rgba(0,0,0,0.06)}
  .td-right{ text-align:right; }

  #warning{margin-top:12px; color:var(--danger); font-weight:800}
  #saldoDisplay{margin-top:10px; font-weight:800; color:var(--accent)}

  .chart-wrap{max-width:420px; margin:20px auto 0 auto}
  canvas{ width:100% !important; height:300px !important; }

  @media (max-width:820px){
    .form-row{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Manajemen Uang</h1>
        <div style="font-size:13px; color:var(--muted)">Simpan otomatis di browser</div>
      </div>
      <div class="date" id="dateDisplay"></div>
    </header>

    <div class="card">
      <!-- Inputs -->
      <label for="saldoAwal">Saldo Awal (Rp)</label>
      <input id="saldoAwal" type="number" placeholder="Masukkan saldo awal (mis. 50000)" />

      <label for="batasPengeluaran">Batas Pengeluaran Maksimal (Rp)</label>
      <input id="batasPengeluaran" type="number" placeholder="Masukkan batas pengeluaran (mis. 40000)" />

      <div id="saldoDisplay">Saldo Sekarang: Rp 0</div>

      <div class="form-row">
        <div class="col">
          <label for="tanggal">Tanggal</label>
          <input id="tanggal" type="date" />
        </div>
        <div class="col">
          <label for="keterangan">Keterangan</label>
          <input id="keterangan" type="text" placeholder="Contoh: Jajan / Gaji / Transport" />
        </div>
      </div>

      <div class="form-row">
        <div class="col">
          <label for="nominal">Nominal (Rp)</label>
          <input id="nominal" type="number" placeholder="Nominal (mis. 15000)" />
        </div>
        <div style="width:160px">
          <label for="jenis">Jenis</label>
          <select id="jenis">
            <option value="pemasukan">Pemasukan</option>
            <option value="pengeluaran">Pengeluaran</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="addBtn">Tambah</button>
        <button class="btn ghost" id="calcBtn">Hitung & Simpan</button>
        <button class="btn ghost" id="resetBtn">Reset Data</button>
      </div>

      <div id="warning"></div>

      <!-- Table -->
      <table id="transTable" aria-label="Tabel transaksi">
        <thead>
          <tr><th style="width:20%">Tanggal</th><th style="width:45%">Keterangan</th><th style="width:20%" class="td-right">Nominal (Rp)</th><th style="width:15%">Jenis / Aksi</th></tr>
        </thead>
        <tbody id="transBody"></tbody>
      </table>

      <div class="chart-wrap">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

<script>
/* Keys for localStorage */
const KEY_DATA = 'man_uang_data_v1';
const KEY_SALDO = 'man_uang_saldo_v1';
const KEY_BATAS = 'man_uang_batas_v1';
const KEY_DATE = 'man_uang_date_v1';

/* Elements */
const dateDisplay = document.getElementById('dateDisplay');
const saldoInput = document.getElementById('saldoAwal');
const batasInput = document.getElementById('batasPengeluaran');
const tanggalInput = document.getElementById('tanggal');
const ketInput = document.getElementById('keterangan');
const nominalInput = document.getElementById('nominal');
const jenisSelect = document.getElementById('jenis');
const addBtn = document.getElementById('addBtn');
const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const transBody = document.getElementById('transBody');
const warningEl = document.getElementById('warning');
const saldoDisplay = document.getElementById('saldoDisplay');
const ctx = document.getElementById('pieChart').getContext('2d');

let dataList = []; // array of {id, tanggal, keterangan, nominal, jenis, warna}
let chart = null;

/* helper */
function todayString(){
  const d = new Date();
  return d.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
}
dateDisplay.textContent = todayString();

/* deterministic color by id (hsl) */
function colorFor(i){
  const hue = (i * 47) % 360; // step
  return `hsl(${hue},65%,55%)`;
}
function genColor(){ return colorFor(dataList.length + 1); }
function uid(){ return 'tx_' + Math.random().toString(36).slice(2,9); }

/* load on init */
function loadAll(){
  try{
    const raw = localStorage.getItem(KEY_DATA);
    dataList = raw ? JSON.parse(raw) : [];
    const savedSaldo = localStorage.getItem(KEY_SALDO);
    const savedBatas = localStorage.getItem(KEY_BATAS);
    const savedDate = localStorage.getItem(KEY_DATE);
    if(savedSaldo !== null) saldoInput.value = Number(savedSaldo);
    if(savedBatas !== null) batasInput.value = Number(savedBatas);
    if(savedDate) tanggalInput.value = savedDate;
  }catch(e){
    console.error('load error', e);
    dataList = [];
  }
  renderTable();
  renderChart();
  updateSaldoAndWarning();
}

/* save snapshot */
function saveAll(){
  try{
    localStorage.setItem(KEY_DATA, JSON.stringify(dataList));
    localStorage.setItem(KEY_SALDO, saldoInput.value || '');
    localStorage.setItem(KEY_BATAS, batasInput.value || '');
    localStorage.setItem(KEY_DATE, tanggalInput.value || '');
  }catch(e){ console.error('save error', e); }
}

/* render table */
function renderTable(){
  transBody.innerHTML = '';
  dataList.forEach((t, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.tanggal}</td>
      <td>${escapeHtml(t.keterangan)}</td>
      <td class="td-right">${Number(t.nominal).toLocaleString('id-ID')}</td>
      <td>
        ${t.jenis}
        <br>
        <button class="btn smallDel" data-id="${t.id}" style="margin-top:6px;padding:6px;border-radius:6px;background:#d32f2f;color:#fff;border:0;cursor:pointer">Hapus</button>
      </td>`;
    transBody.appendChild(tr);
  });
  // attach delete handlers
  document.querySelectorAll('.smallDel').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = btn.getAttribute('data-id');
      deleteTx(id);
    });
  });
}

/* delete transaction */
function deleteTx(id){
  const idx = dataList.findIndex(x=>x.id===id);
  if(idx === -1) return;
  dataList.splice(idx,1);
  // after deletion, per requirement we should update saldo awal to current balance as well
  // we'll recompute and store updated saldo into saldoInput (so "saldo awal ikut berubah")
  const currentSaldo = computeSaldo();
  saldoInput.value = currentSaldo;
  saveAll();
  renderTable();
  renderChart();
  updateSaldoAndWarning();
}

/* compute current saldo: saldoInput(initial) + total_pemasukan - total_pengeluaran
   Note: we will treat saldoInput as "base" and then update it to reflect changes when asked (we also set it after add/delete) */
function computeSaldo(){
  const base = Number(saldoInput.value) || 0;
  const totalIn = dataList.filter(d=>d.jenis==='pemasukan').reduce((s,x)=>s + Number(x.nominal),0);
  const totalOut = dataList.filter(d=>d.jenis==='pengeluaran').reduce((s,x)=>s + Number(x.nominal),0);
  return base + totalIn - totalOut;
}

/* update displayed saldo and warning */
function updateSaldoAndWarning(){
  const saldoNow = computeSaldo();
  saldoDisplay.textContent = 'Saldo Sekarang: Rp ' + Number(saldoNow).toLocaleString('id-ID');

  // check batas
  const batas = Number(batasInput.value) || 0;
  const totalOut = dataList.filter(d=>d.jenis==='pengeluaran').reduce((s,x)=>s + Number(x.nominal),0);

  // warning if totalOut > batas AND saldo negative (or regardless?) We use: warning shown if totalOut > batas
  if(batas > 0 && totalOut > batas){
    warningEl.textContent = '⚠️ Pengeluaran melebihi batas!';
  } else {
    warningEl.textContent = '';
  }

  // also hide warning when saldo becomes non-negative
  if(saldoNow >= 0){
    warningEl.textContent = '';
  }

  // persist saldoInput to reflect "saldo awal otomatis ikut berubah" — keep behavior consistent:
  // set saldoInput to saldoNow so next operations start from updated baseline
  saldoInput.value = saldoNow;
  saveAll();
}

/* render pie chart: each transaction is a slice */
function renderChart(){
  const labels = dataList.map(d => `${d.jenis} — ${d.keterangan}`);
  const values = dataList.map(d => Number(d.nominal));
  const colors = dataList.map((d,i)=> d.warna || colorForIndex(i));

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }]},
    options: {
      plugins:{
        tooltip:{
          callbacks:{
            label: function(context){
              const idx = context.dataIndex;
              const val = context.dataset.data[idx];
              const total = context.dataset.data.reduce((a,b)=>a+b,0);
              const pct = total ? (val/total*100).toFixed(1) : 0;
              const deg = total ? Math.round(val/total*360) : 0;
              return `${context.label}: Rp ${Number(val).toLocaleString('id-ID')} (${pct}% ≈ ${deg}°)`;
            }
          }
        },
        legend:{ position:'bottom' }
      }
    }
  });
}

/* color generator stored on item if not present */
function colorForIndex(i){ return `hsl(${(i*47)%360},65%,55%)`; }

/* escape */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Add new transaction */
function addTransaction(){
  const tgl = tanggalInput.value || (new Date()).toISOString().slice(0,10);
  const ket = ketInput.value.trim();
  const nom = Number(nominalInput.value);
  const jenis = jenisSelect.value;

  if(!ket || !nom || nom <= 0){
    alert('Lengkapi keterangan dan nominal yang benar.');
    return;
  }

  const id = uid();
  const warna = colorForIndex(dataList.length);
  dataList.push({ id, tanggal: tgl, keterangan: ket, nominal: nom, jenis, warna });

  // update table + chart + saldo + save
  renderTable();
  renderChart();

  // update saldo: as requirement said, saldo awal otomatis ikut berubah -> set saldoInput to new balance
  const newSaldo = computeSaldo();
  saldoInput.value = newSaldo;

  updateSaldoAndWarning();
  saveAll();

  // clear inputs (except date)
  ketInput.value = '';
  nominalInput.value = '';
}

/* calc button handler: recompute and save (keamanannya) */
function calcAndSave(){
  // ensure table and chart reflect dataList
  renderTable();
  renderChart();
  // update saldo display (and write saldo input to current balance)
  const newSaldo = computeSaldo();
  saldoInput.value = newSaldo;
  updateSaldoAndWarning();
  saveAll();
  alert('Data dihitung dan disimpan.');
}

/* reset all */
function resetAll(){
  if(!confirm('Hapus semua data?')) return;
  dataList = [];
  transBody.innerHTML = '';
  if(chart) chart.destroy();
  saldoInput.value = '';
  batasInput.value = '';
  tanggalInput.value = '';
  ketInput.value = '';
  nominalInput.value = '';
  jenisSelect.value = 'pemasukan';
  warningEl.textContent = '';
  saldoDisplay.textContent = 'Saldo Sekarang: Rp 0';
  localStorage.removeItem(KEY_DATA);
  localStorage.removeItem(KEY_SALDO);
  localStorage.removeItem(KEY_BATAS);
  localStorage.removeItem(KEY_DATE);
}

/* attach events */
addBtn.addEventListener('click', addTransaction);
calcBtn.addEventListener('click', calcAndSave);
resetBtn.addEventListener('click', resetAll);

/* initial load */
loadAll();

</script>
</body>
</html>